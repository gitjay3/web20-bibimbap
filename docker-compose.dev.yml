services:
  # 로컬 개발용 nginx (SSL 없이 HTTP만)
  nginx:
    ports: !override
      - "${NGINX_PORT:-80}:80"
    volumes: !override
      - ./nginx/nginx.dev.conf:/etc/nginx/nginx.conf:ro

  backend:
    build:
      context: .
      target: deps
    command: sh -c "pnpm --filter backend prisma migrate deploy && pnpm --filter backend prisma generate && pnpm --filter backend start:dev"
    deploy: !override
      resources:
        limits:
          memory: 1024M
    environment:
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redis123} # 추후 Redis 설정  다듬으면서 수정 필요할 수도 있음
    volumes:
      - ./backend:/app/backend
      - ./package.json:/app/package.json:ro
      - ./pnpm-lock.yaml:/app/pnpm-lock.yaml:ro
      - ./pnpm-workspace.yaml:/app/pnpm-workspace.yaml:ro
      - backend-node-modules:/app/backend/node_modules

  frontend:
    build:
      context: .
      target: deps
    command: pnpm --filter frontend exec vite --host 0.0.0.0 --port 8080
    deploy: !override
      resources:
        limits:
          memory: 512M
    environment:
      - CHOKIDAR_USEPOLLING=true
    volumes:
      - ./frontend:/app/frontend
      - ./package.json:/app/package.json:ro
      - ./pnpm-lock.yaml:/app/pnpm-lock.yaml:ro
      - ./pnpm-workspace.yaml:/app/pnpm-workspace.yaml:ro
      - frontend-node-modules:/app/frontend/node_modules
    ports:
      - 8080:8080

  redis:
    deploy: !override
      resources:
        limits:
          memory: 256M

volumes:
  backend-node-modules:
  frontend-node-modules:
