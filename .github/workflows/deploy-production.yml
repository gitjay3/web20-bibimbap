name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy (optional, default: production-{SHA})'
        required: false
        type: string

# Production ë°°í¬ëŠ” í•œ ë²ˆì— í•˜ë‚˜ì”©ë§Œ
concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest

    env:
      IMAGE_TAG: ${{ inputs.image_tag || format('production-{0}', github.sha) }}

    strategy:
      matrix:
        service:
          - backend
          - frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to NCP Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.NCP_REGISTRY_URL }}
          username: ${{ secrets.NCP_REGISTRY_USERNAME }}
          password: ${{ secrets.NCP_REGISTRY_PASSWORD }}

      - name: Extract version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=v${VERSION}" >> $GITHUB_OUTPUT

      - name: Build and push ${{ matrix.service }} image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            ${{ secrets.NCP_REGISTRY_URL }}/bookstcamp-${{ matrix.service }}:${{ env.IMAGE_TAG }}
            ${{ secrets.NCP_REGISTRY_URL }}/bookstcamp-${{ matrix.service }}:production-latest
            ${{ secrets.NCP_REGISTRY_URL }}/bookstcamp-${{ matrix.service }}:${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production

      - name: Image built successfully
        run: |
          echo "âœ… ${{ matrix.service }} image built and pushed"
          echo "Tags:"
          echo "  - ${{ env.IMAGE_TAG }}"
          echo "  - production-latest"
          echo "  - ${{ steps.version.outputs.version }}"

  # Production ë°°í¬ (ìžë™)
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    needs: build-and-push

    env:
      IMAGE_TAG: ${{ inputs.image_tag || format('production-{0}', github.sha) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PRODUCTION_SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Backup current deployment
        run: |
          ssh ${{ secrets.PRODUCTION_SERVER_USER }}@${{ secrets.PRODUCTION_SERVER_HOST }} << 'EOF'
            set -e
            cd ~/bookstcamp

            # í˜„ìž¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ì •ë³´ ë°±ì—…
            mkdir -p backups
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            docker compose -f docker-compose.yml ps > backups/pre-deploy-containers-${TIMESTAMP}.txt || true
            docker compose -f docker-compose.yml images > backups/pre-deploy-images-${TIMESTAMP}.txt || true

            echo "Backup completed: ${TIMESTAMP}"
          EOF

      - name: Setup dotenvx
        run: |
          npm install -g @dotenvx/dotenvx

      - name: Create temporary env file with decrypted DATABASE_URL
        env:
          DOTENV_PRIVATE_KEY_PRODUCTION: ${{ secrets.DOTENVX_PRIVATE_KEY_PRODUCTION }}
        run: |
          # DATABASE_URL ë³µí˜¸í™”
          DATABASE_URL=$(dotenvx get DATABASE_URL -f .env.production)

          # deploy.env ìƒì„±
          cat > /tmp/deploy.env << EOF
ENVIRONMENT=production
NCP_REGISTRY_URL=${{ secrets.NCP_REGISTRY_URL }}
NCP_REGISTRY_USERNAME=${{ secrets.NCP_REGISTRY_USERNAME }}
NCP_REGISTRY_PASSWORD=${{ secrets.NCP_REGISTRY_PASSWORD }}
IMAGE_TAG=${{ env.IMAGE_TAG }}
DOTENV_PRIVATE_KEY_PRODUCTION=${{ secrets.DOTENVX_PRIVATE_KEY_PRODUCTION }}
DATABASE_URL=${DATABASE_URL}
EOF
          chmod 600 /tmp/deploy.env

      - name: Copy deployment files to server
        run: |
          scp -r scripts/ ${{ secrets.PRODUCTION_SERVER_USER }}@${{ secrets.PRODUCTION_SERVER_HOST }}:~/bookstcamp/
          scp docker-compose.yml ${{ secrets.PRODUCTION_SERVER_USER }}@${{ secrets.PRODUCTION_SERVER_HOST }}:~/bookstcamp/docker-compose.yml
          scp .env.production ${{ secrets.PRODUCTION_SERVER_USER }}@${{ secrets.PRODUCTION_SERVER_HOST }}:~/bookstcamp/.env.production
          scp /tmp/deploy.env ${{ secrets.PRODUCTION_SERVER_USER }}@${{ secrets.PRODUCTION_SERVER_HOST }}:~/bookstcamp/.deploy.env
          rm /tmp/deploy.env

      - name: Clean up old containers and networks
        run: |
          ssh ${{ secrets.PRODUCTION_SERVER_USER }}@${{ secrets.PRODUCTION_SERVER_HOST }} << 'EOF'
            cd ~/bookstcamp

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆì™€ ë„¤íŠ¸ì›Œí¬ ì •ë¦¬
            docker compose -f docker-compose.yml down --remove-orphans 2>/dev/null || true

            # ì´ë¦„ì´ ë‹¤ë¥¸ ê¸°ì¡´ ë„¤íŠ¸ì›Œí¬ ì •ë¦¬ (prod vs production)
            docker network rm bookstcamp-prod-network 2>/dev/null || true
            docker network rm bookstcamp-production-network 2>/dev/null || true
          EOF

      - name: Deploy on production server
        run: |
          ssh ${{ secrets.PRODUCTION_SERVER_USER }}@${{ secrets.PRODUCTION_SERVER_HOST }} << 'EOF'
            set -e
            cd ~/bookstcamp

            # í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
            set -a
            source .deploy.env
            set +a

            # ë³´ì•ˆ: ì¦‰ì‹œ ì‚­ì œ
            rm -f .deploy.env

            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            chmod +x scripts/*.sh
            ./scripts/deploy.sh prod
          EOF

      - name: Verify deployment (strict)
        run: |
          ssh ${{ secrets.PRODUCTION_SERVER_USER }}@${{ secrets.PRODUCTION_SERVER_HOST }} << 'EOF'
            cd ~/bookstcamp

            # Productionì€ ë” ì—„ê²©í•˜ê²Œ ê²€ì¦ (10íšŒ ìž¬ì‹œë„)
            ./scripts/health-check.sh prod 10

            echo "Waiting 30 seconds for services to stabilize..."
            sleep 30

            # í•œ ë²ˆ ë” ê²€ì¦
            ./scripts/health-check.sh prod 3
          EOF

      - name: Post-deployment monitoring
        run: |
          ssh ${{ secrets.PRODUCTION_SERVER_USER }}@${{ secrets.PRODUCTION_SERVER_HOST }} << 'EOF'
            cd ~/bookstcamp

            echo "=== Deployment Summary ==="
            echo "Deployed at: $(date)"
            echo ""
            echo "=== Running Containers ==="
            docker compose -f docker-compose.yml ps
            echo ""
            echo "=== Container Resource Usage ==="
            docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}" $(docker compose -f docker-compose.yml ps -q)
          EOF
          echo ""
          echo "Image tag: ${{ env.IMAGE_TAG }}"

      - name: Deployment successful
        run: |
          echo "âœ… Production deployment completed successfully!"
          echo "Image tag: ${{ env.IMAGE_TAG }}"
          echo "Deployed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

  # ë°°í¬ ì‹¤íŒ¨ ì‹œ ìžë™ ë¡¤ë°±
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PRODUCTION_SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Execute rollback
        run: |
          ssh ${{ secrets.PRODUCTION_SERVER_USER }}@${{ secrets.PRODUCTION_SERVER_HOST }} << 'EOF'
            set -e
            cd ~/bookstcamp

            echo "ðŸ”„ Executing automatic rollback..."
            ./scripts/rollback.sh prod

            echo "Waiting for services to stabilize..."
            sleep 20

            echo "Verifying rollback..."
            ./scripts/health-check.sh prod 5
          EOF

      - name: Rollback completed
        run: |
          echo "âš ï¸ Production deployment failed and was rolled back"
          echo "Please check the logs and fix the issue before redeploying"
          echo "ðŸ” Investigate: ssh ${{ secrets.PRODUCTION_SERVER_USER }}@${{ secrets.PRODUCTION_SERVER_HOST }} 'cd ~/bookstcamp && docker compose -f docker-compose.yml logs'"
