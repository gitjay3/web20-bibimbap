name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

# Production ë°°í¬ëŠ” í•œ ë²ˆì— í•˜ë‚˜ì”©ë§Œ
concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service:
          - backend
          - frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to NCP Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.NCP_REGISTRY_URL }}
          username: ${{ secrets.NCP_REGISTRY_USERNAME }}
          password: ${{ secrets.NCP_REGISTRY_PASSWORD }}

      - name: Extract version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=v${VERSION}" >> $GITHUB_OUTPUT

      - name: Build and push ${{ matrix.service }} image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            ${{ secrets.NCP_REGISTRY_URL }}/bookstcamp-${{ matrix.service }}:production-latest
            ${{ secrets.NCP_REGISTRY_URL }}/bookstcamp-${{ matrix.service }}:${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Image built successfully
        run: |
          echo "âœ… ${{ matrix.service }} image built and pushed"
          echo "Tags: production-latest, ${{ steps.version.outputs.version }}"

  # Production ë°°í¬ (ìžë™)
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PRODUCTION_SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Setup dotenvx
        run: |
          npm install -g @dotenvx/dotenvx

      - name: Create temporary env file with decrypted DATABASE_URL
        env:
          DOTENV_PRIVATE_KEY_PRODUCTION: ${{ secrets.DOTENVX_PRIVATE_KEY_PRODUCTION }}
          NCP_REGISTRY_URL: ${{ secrets.NCP_REGISTRY_URL }}
          NCP_REGISTRY_USERNAME: ${{ secrets.NCP_REGISTRY_USERNAME }}
          NCP_REGISTRY_PASSWORD: ${{ secrets.NCP_REGISTRY_PASSWORD }}
        run: |
          # DATABASE_URL ë³µí˜¸í™”
          DATABASE_URL=$(dotenvx get DATABASE_URL -f .env.production)

          # deploy.env ìƒì„±
          {
            echo "ENVIRONMENT=production"
            echo "NCP_REGISTRY_URL=${NCP_REGISTRY_URL}"
            echo "NCP_REGISTRY_USERNAME=${NCP_REGISTRY_USERNAME}"
            echo "NCP_REGISTRY_PASSWORD=${NCP_REGISTRY_PASSWORD}"
            echo "DOTENV_PRIVATE_KEY_PRODUCTION=${DOTENV_PRIVATE_KEY_PRODUCTION}"
            echo "DATABASE_URL=${DATABASE_URL}"
          } > /tmp/deploy.env
          chmod 600 /tmp/deploy.env

      - name: Copy deployment files to server
        run: |
          scp -r scripts/ ${{ secrets.PRODUCTION_SERVER_USER }}@${{ secrets.PRODUCTION_SERVER_HOST }}:~/bookstcamp/
          scp docker-compose.yml ${{ secrets.PRODUCTION_SERVER_USER }}@${{ secrets.PRODUCTION_SERVER_HOST }}:~/bookstcamp/docker-compose.yml
          scp .env.production ${{ secrets.PRODUCTION_SERVER_USER }}@${{ secrets.PRODUCTION_SERVER_HOST }}:~/bookstcamp/.env.production
          scp /tmp/deploy.env ${{ secrets.PRODUCTION_SERVER_USER }}@${{ secrets.PRODUCTION_SERVER_HOST }}:~/bookstcamp/.deploy.env
          rm /tmp/deploy.env

      - name: Deploy on production server
        run: |
          ssh ${{ secrets.PRODUCTION_SERVER_USER }}@${{ secrets.PRODUCTION_SERVER_HOST }} << 'EOF'
            set -e
            cd ~/bookstcamp

            # í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
            set -a
            source .deploy.env
            set +a

            # ë³´ì•ˆ: ì¦‰ì‹œ ì‚­ì œ
            rm -f .deploy.env

            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            chmod +x scripts/*.sh
            ./scripts/deploy.sh prod
          EOF

      - name: Verify deployment
        run: |
          ssh ${{ secrets.PRODUCTION_SERVER_USER }}@${{ secrets.PRODUCTION_SERVER_HOST }} << 'EOF'
            cd ~/bookstcamp

            echo "Waiting for containers to start..."
            sleep 10

            echo "=== Container Status ==="
            docker ps --format "table {{.Names}}\t{{.Status}}"
          EOF

      - name: Post-deployment monitoring
        run: |
          ssh ${{ secrets.PRODUCTION_SERVER_USER }}@${{ secrets.PRODUCTION_SERVER_HOST }} << 'EOF'
            cd ~/bookstcamp

            echo "=== Deployment Summary ==="
            echo "Deployed at: $(date)"
            echo ""
            echo "=== Running Containers ==="
            docker compose -f docker-compose.yml ps
            echo ""
            echo "=== Container Resource Usage ==="
            docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}" $(docker compose -f docker-compose.yml ps -q)
          EOF

      - name: Deployment successful
        run: |
          echo "âœ… Production deployment completed successfully!"
          echo "Deployed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

  # ë°°í¬ ì‹¤íŒ¨ ì‹œ ìžë™ ë¡¤ë°±
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PRODUCTION_SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Execute rollback
        run: |
          ssh ${{ secrets.PRODUCTION_SERVER_USER }}@${{ secrets.PRODUCTION_SERVER_HOST }} << 'EOF'
            set -e
            cd ~/bookstcamp

            echo "ðŸ”„ Executing automatic rollback..."
            ./scripts/rollback.sh prod

            echo "Waiting for services to stabilize..."
            sleep 10

            echo "=== Container Status ==="
            docker ps --format "table {{.Names}}\t{{.Status}}"
          EOF

      - name: Rollback completed
        run: |
          echo "âš ï¸ Production deployment failed and was rolled back"
          echo "Please check the logs and fix the issue before redeploying"
          echo "ðŸ” Investigate: ssh ${{ secrets.PRODUCTION_SERVER_USER }}@${{ secrets.PRODUCTION_SERVER_HOST }} 'cd ~/bookstcamp && docker compose -f docker-compose.yml logs'"
